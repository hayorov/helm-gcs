name: integration-tests

# Integration Tests with GCP
#
# This workflow runs integration tests against a real GCS bucket using one of two auth methods:
#
# Method 1: Service Account Key (simpler, less secure)
#   Required repository secrets/variables:
#   - Secret: GCS_TEST_CREDENTIALS (Service account JSON key)
#   - Variable: GCS_TEST_BUCKET (e.g., gs://my-bucket/test-path)
#
# Method 2: Workload Identity Federation (recommended, more secure)
#   Required repository secrets/variables:
#   - Secret: WIF_PROVIDER (Workload Identity Provider resource name)
#   - Secret: WIF_SERVICE_ACCOUNT (Service account email)
#   - Variable: GCS_TEST_BUCKET (e.g., gs://my-bucket/test-path)
#
# Configure these in: Repository Settings > Secrets and variables > Actions
# See .github/INTEGRATION_TESTS_SETUP.md for detailed setup instructions

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'pkg/**'
      - 'cmd/**'
      - 'integration/**'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/integration-test.yml'

jobs:
  integration:
    runs-on: ubuntu-latest
    # Run if bucket is configured in repository variables
    if: vars.GCS_TEST_BUCKET != ''

    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Determine authentication method
        id: auth-method
        run: |
          if [ -n "${{ secrets.WIF_PROVIDER }}" ]; then
            echo "method=workload-identity" >> $GITHUB_OUTPUT
            echo "Using Workload Identity Federation"
          elif [ -n "${{ secrets.GCS_TEST_CREDENTIALS }}" ]; then
            echo "method=service-account-key" >> $GITHUB_OUTPUT
            echo "Using Service Account Key"
          else
            echo "ERROR: No valid authentication method configured"
            echo "Please set either GCS_TEST_CREDENTIALS or WIF_PROVIDER secret"
            exit 1
          fi

      - name: Authenticate to Google Cloud (Workload Identity)
        if: steps.auth-method.outputs.method == 'workload-identity'
        id: auth-wif
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Authenticate to Google Cloud (Service Account Key)
        if: steps.auth-method.outputs.method == 'service-account-key'
        id: auth-key
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCS_TEST_CREDENTIALS }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify GCP authentication
        run: |
          echo "Testing GCP authentication..."
          gcloud auth list
          echo "Testing GCS access..."
          BUCKET_NAME=$(echo "${{ vars.GCS_TEST_BUCKET }}" | sed 's|gs://||' | cut -d'/' -f1)
          gsutil ls "gs://$BUCKET_NAME" || echo "Warning: Cannot list bucket contents"

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version
          echo "Helm version: $(helm version --short)"

      - name: Run integration tests
        env:
          GCS_TEST_BUCKET: ${{ vars.GCS_TEST_BUCKET }}
          HELM_GCS_DEBUG: ${{ vars.HELM_GCS_DEBUG || 'false' }}
        run: |
          echo "========================================="
          echo "Integration Test Configuration"
          echo "========================================="
          echo "GCS Bucket: $GCS_TEST_BUCKET"
          echo "Auth Method: ${{ steps.auth-method.outputs.method }}"
          echo "Debug Mode: $HELM_GCS_DEBUG"
          echo "========================================="
          echo ""

          # Run integration tests with enhanced output
          go test -v -race -timeout 10m ./pkg/repo 2>&1 | tee integration-test-output.log

          # Check test results
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo ""
            echo "========================================="
            echo "âœ… All integration tests passed!"
            echo "========================================="
          else
            echo ""
            echo "========================================="
            echo "âŒ Integration tests failed"
            echo "========================================="
            exit 1
          fi

      - name: Cleanup test artifacts
        if: always()
        run: |
          echo "Cleaning up test artifacts..."
          # Tests should auto-cleanup, but this is a safety measure
          gsutil -m rm -r "gs://$(echo ${{ vars.GCS_TEST_BUCKET }} | sed 's|gs://||')/create-repo-*" 2>/dev/null || true
          gsutil -m rm -r "gs://$(echo ${{ vars.GCS_TEST_BUCKET }} | sed 's|gs://||')/push-chart-*" 2>/dev/null || true
          gsutil -m rm -r "gs://$(echo ${{ vars.GCS_TEST_BUCKET }} | sed 's|gs://||')/remove-chart-*" 2>/dev/null || true
          gsutil -m rm -r "gs://$(echo ${{ vars.GCS_TEST_BUCKET }} | sed 's|gs://||')/concurrent-*" 2>/dev/null || true
          echo "âœ“ Cleanup complete"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            integration-test-output.log
          retention-days: 30

      - name: Test Summary
        if: always()
        run: |
          echo "### Integration Test Results ðŸ§ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Bucket**: \`${{ vars.GCS_TEST_BUCKET }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Auth Method**: ${{ steps.auth-method.outputs.method }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f integration-test-output.log ]; then
            # Extract test results
            PASS_COUNT=$(grep -c "PASS:" integration-test-output.log || echo "0")
            FAIL_COUNT=$(grep -c "FAIL:" integration-test-output.log || echo "0")

            echo "**Results**:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Passed: $PASS_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ Failed: $FAIL_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
