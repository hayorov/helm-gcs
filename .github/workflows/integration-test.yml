name: integration-tests

# Integration Tests with GCP
#
# This workflow runs integration tests against a real GCS bucket.
#
# Required GitHub Actions Configuration:
#   Secrets (Repository Settings > Secrets and variables > Actions > Secrets):
#   - GCS_TEST_CREDENTIALS: Service account JSON key CONTENT (entire JSON file content)
#     Note: In GitHub Actions, this contains the JSON content itself, not a file path
#     The workflow will automatically create a temporary file and set GOOGLE_APPLICATION_CREDENTIALS
#
#   Variables (Repository Settings > Secrets and variables > Actions > Variables):
#   - GCS_TEST_BUCKET: GCS bucket path (e.g., gs://my-bucket/test-path)
#   - HELM_GCS_DEBUG: Enable debug mode (optional, default: false)
#
# Local Development:
#   For local development, use .env file with:
#   - GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account-key.json (file path)
#   - GCS_TEST_BUCKET=gs://your-bucket/test-path
#
# This workflow:
#   1. Runs only after the 'test' workflow completes successfully
#   2. Validates all required secrets and variables are configured
#   3. Uses Service Account Key authentication from GCS_TEST_CREDENTIALS secret
#   4. Loads test configuration from repository variables

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["test"]
    types:
      - completed
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'pkg/**'
      - 'cmd/**'
      - 'integration/**'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/integration-test.yml'

jobs:
  integration:
    runs-on: ubuntu-latest
    # Only run if:
    # 1. Test workflow completed successfully (or triggered manually/by PR)
    # 2. GCS_TEST_BUCKET is configured in repository variables
    if: |
      vars.GCS_TEST_BUCKET != '' &&
      (github.event_name == 'workflow_dispatch' ||
       github.event_name == 'pull_request' ||
       github.event.workflow_run.conclusion == 'success')

    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation

    strategy:
      matrix:
        helm-version: ['3', '4']
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets and variables
        run: |
          echo "========================================="
          echo "Validating GitHub Actions Configuration"
          echo "========================================="

          ERRORS=0

          # Validate Variables (from Repository Variables)
          if [ -z "${{ vars.GCS_TEST_BUCKET }}" ]; then
            echo "âŒ ERROR: GCS_TEST_BUCKET variable is not set"
            echo "   Configure in: Repository Settings > Secrets and variables > Actions > Variables"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ“ GCS_TEST_BUCKET (Variable): ${{ vars.GCS_TEST_BUCKET }}"
          fi

          if [ -z "${{ vars.HELM_GCS_DEBUG }}" ]; then
            echo "â„¹ HELM_GCS_DEBUG (Variable): not set, will use default (false)"
          else
            echo "âœ“ HELM_GCS_DEBUG (Variable): ${{ vars.HELM_GCS_DEBUG }}"
          fi

          # Validate Secrets (from Repository Secrets)
          if [ -z "${{ secrets.GCS_TEST_CREDENTIALS }}" ]; then
            echo "âŒ ERROR: GCS_TEST_CREDENTIALS secret is not set"
            echo "   This should contain the ENTIRE JSON content of your service account key"
            echo "   Configure in: Repository Settings > Secrets and variables > Actions > Secrets"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ“ GCS_TEST_CREDENTIALS (Secret): configured (JSON content)"
            echo "   Note: Contains service account JSON (not a file path)"
          fi

          echo "========================================="

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "Integration tests cannot run due to missing configuration."
            echo "Please configure the required secrets and variables in:"
            echo "Repository Settings > Secrets and variables > Actions"
            exit 1
          fi

          echo "âœ“ All required secrets and variables are configured"
          echo ""

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Authenticate to Google Cloud (Service Account Key)
        id: auth-key
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCS_TEST_CREDENTIALS }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Verify credentials file creation
        run: |
          echo "========================================="
          echo "GCP Credentials Configuration"
          echo "========================================="
          echo "Source: GCS_TEST_CREDENTIALS secret (JSON content)"
          echo "Action: Created temporary credentials file"
          if [ -n "$GOOGLE_APPLICATION_CREDENTIALS" ]; then
            echo "âœ“ GOOGLE_APPLICATION_CREDENTIALS: $GOOGLE_APPLICATION_CREDENTIALS"
            if [ -f "$GOOGLE_APPLICATION_CREDENTIALS" ]; then
              echo "âœ“ Credentials file exists"
              echo "  File size: $(stat -f%z "$GOOGLE_APPLICATION_CREDENTIALS" 2>/dev/null || stat -c%s "$GOOGLE_APPLICATION_CREDENTIALS" 2>/dev/null) bytes"
            else
              echo "âŒ ERROR: Credentials file not found"
              exit 1
            fi
          else
            echo "âŒ ERROR: GOOGLE_APPLICATION_CREDENTIALS not set"
            exit 1
          fi
          echo "========================================="
          echo ""

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify GCP authentication
        run: |
          echo "Testing GCP authentication..."
          gcloud auth list
          echo "Testing GCS access..."
          BUCKET_NAME=$(echo "${{ vars.GCS_TEST_BUCKET }}" | sed 's|gs://||' | cut -d'/' -f1)
          gsutil ls "gs://$BUCKET_NAME" || echo "Warning: Cannot list bucket contents"

      - name: Install Helm ${{ matrix.helm-version }}
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-${{ matrix.helm-version }} | bash
          helm version
          echo "Helm version: $(helm version --short)"

      - name: Run integration tests
        env:
          GCS_TEST_BUCKET: ${{ vars.GCS_TEST_BUCKET }}
          HELM_GCS_DEBUG: ${{ vars.HELM_GCS_DEBUG || 'false' }}
        run: |
          echo "========================================="
          echo "Integration Test Configuration"
          echo "========================================="
          echo "GCS Bucket (from Variables): $GCS_TEST_BUCKET"
          echo "Debug Mode (from Variables): $HELM_GCS_DEBUG"
          echo "Auth Method: Service Account Key (from Secrets)"
          echo "========================================="
          echo ""

          # Run integration tests with enhanced output
          go test -v -race -tags=integration -timeout 10m ./pkg/repo 2>&1 | tee integration-test-output.log

          # Check test results
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo ""
            echo "========================================="
            echo "âœ… All integration tests passed!"
            echo "========================================="
          else
            echo ""
            echo "========================================="
            echo "âŒ Integration tests failed"
            echo "========================================="
            exit 1
          fi

      - name: Cleanup test artifacts
        if: always()
        run: |
          echo "Cleaning up test artifacts..."
          # Tests should auto-cleanup, but this is a safety measure
          gsutil -m rm -r "gs://$(echo ${{ vars.GCS_TEST_BUCKET }} | sed 's|gs://||')/create-repo-*" 2>/dev/null || true
          gsutil -m rm -r "gs://$(echo ${{ vars.GCS_TEST_BUCKET }} | sed 's|gs://||')/push-chart-*" 2>/dev/null || true
          gsutil -m rm -r "gs://$(echo ${{ vars.GCS_TEST_BUCKET }} | sed 's|gs://||')/remove-chart-*" 2>/dev/null || true
          gsutil -m rm -r "gs://$(echo ${{ vars.GCS_TEST_BUCKET }} | sed 's|gs://||')/concurrent-*" 2>/dev/null || true
          echo "âœ“ Cleanup complete"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-helm-${{ matrix.helm-version }}
          path: |
            integration-test-output.log
          retention-days: 30

      - name: Test Summary
        if: always()
        run: |
          echo "### Integration Test Results ðŸ§ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- GCS Bucket (Variable): \`${{ vars.GCS_TEST_BUCKET }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Debug Mode (Variable): \`${{ vars.HELM_GCS_DEBUG || 'false' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Auth Method: Service Account Key (Secret)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f integration-test-output.log ]; then
            # Extract test results
            PASS_COUNT=$(grep -c "PASS:" integration-test-output.log || echo "0")
            FAIL_COUNT=$(grep -c "FAIL:" integration-test-output.log || echo "0")

            echo "**Results:**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Passed: $PASS_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ Failed: $FAIL_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
